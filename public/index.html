<!DOCTYPE html>
<html lang="kk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∞“£“ì—ã—Å—Ç–∞—É –∞—Ä—Ö–µ–æ–ª–æ–≥–∏—è–ª—ã“õ –∫–∞—Ä—Ç–∞ ‚Äî Enhanced</title>

<!-- Leaflet + Routing + MarkerCluster + noUiSlider -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css"/>

<style>
  :root{ --bg:#f6f8fb; --card:#fff; --accent:#1976d2; --text:#111; --touch-size:48px; }
  [data-theme="dark"]{ --bg:#0f1724; --card:#0b1220; --accent:#3b82f6; --text:#e6eef8; }
  *{box-sizing:border-box}
  html,body,#map{height:100%}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text)}
  header{display:flex;gap:12px;align-items:center;padding:12px 14px;background:linear-gradient(90deg,rgba(25,118,210,.08),transparent);border-bottom:1px solid rgba(0,0,0,.04)}
  .brand{font-weight:700;color:var(--accent)}
  .controls{display:flex;gap:8px;align-items:center;margin-left:auto}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600;min-height:var(--touch-size)}
  .toggle{background:transparent;border:1px solid rgba(0,0,0,.08);padding:6px 8px;border-radius:8px;cursor:pointer;min-height:var(--touch-size)}
  #topbar {padding:8px 14px;display:flex;gap:10px;align-items:center}
  #map {height:65vh;width:100%}
  #main {display:grid;grid-template-columns:1fr 420px;gap:18px;padding:16px;max-width:1200px;margin:0 auto}
  #panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(2,6,23,.08);max-height:70vh;overflow:auto}
  .card-list{display:grid;grid-template-columns:1fr;gap:10px}
  .card{display:flex;gap:10px;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);border-radius:10px;padding:8px;align-items:flex-start}
  .card img{width:120px;height:80px;object-fit:cover;border-radius:8px}
  .card .meta{flex:1}
  .card h3{margin:0;font-size:16px;color:var(--accent)}
  .card p{margin:6px 0;font-size:13px;color:var(--text)}
  .small{font-size:12px;color:gray;margin-top:6px}
  .controls-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  input[type="text"]{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,.08);width:260px}
  select{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,.08)}
  .fav{background:transparent;border:none;cursor:pointer;font-size:18px;min-height:var(--touch-size)}
  .pill{display:inline-flex;padding:6px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.02)}
  .chip{font-size:12px;padding:4px 6px;border-radius:6px;border:1px solid rgba(0,0,0,.06)}
  .faq-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .faq-btn{padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,.06);background:transparent;cursor:pointer;min-height:var(--touch-size)}
  .mobile-toggle{display:none}
  /* Chat widget (compact) */
  #chat-toggle{position:fixed;right:18px;bottom:18px;border-radius:999px;padding:12px 14px;background:var(--accent);color:#fff;border:none;z-index:3000;cursor:pointer}
  #chat-widget{position:fixed;right:18px;bottom:76px;width:360px;max-height:70vh;background:var(--card);border-radius:12px;box-shadow:0 20px 50px rgba(2,6,23,.3);display:none;flex-direction:column;overflow:hidden;z-index:3000;border:1px solid rgba(0,0,0,.06)}
  .cw-header{padding:10px;background:linear-gradient(90deg,var(--accent),transparent);color:#fff;font-weight:700;display:flex;align-items:center;justify-content:space-between}
  .cw-body{padding:10px;height:46vh;overflow:auto}
  .cw-input{display:flex;padding:10px;border-top:1px solid rgba(0,0,0,.04)}
  .cw-input input{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,.06)}
  .cw-input button{margin-left:8px}
  .msg-bot{background:rgba(0,0,0,.04);padding:8px;border-radius:10px;margin:8px 0;display:inline-block}
  .msg-user{background:var(--accent);color:#fff;padding:8px;border-radius:10px;margin:8px 0;display:inline-block;float:right}
  footer{padding:16px;text-align:center;color:gray;font-size:13px}
  @media(max-width:960px){
    #main{grid-template-columns:1fr;padding:8px}
    #panel{max-height:40vh}
  }
  @media(max-width:800px){
    /* Mobile: show map fullscreen and make panel collapsible bottom sheet */
    #map{height:calc(100vh - 120px)}
    .mobile-toggle{display:block}
    #main{grid-template-columns:1fr; gap:0}
    #rightCol{position:fixed;left:0;right:0;bottom:0;z-index:2500;pointer-events:none}
    #panel{pointer-events:auto; border-radius:12px 12px 0 0; max-height:60vh; overflow:auto; margin:0 8px; padding-bottom:24px}
    .controls-row {flex-wrap:wrap}
    .btn, .toggle {min-height:42px}
  }
</style>
</head>
<body data-theme="light">

<header>
  <div class="brand">Mangystau Map AI</div>
  <div class="small">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ –∞—Ä—Ö–µ–æ–ª–æ–≥–∏—è–ª—ã“õ –∫–∞—Ä—Ç–∞ ‚Äî –æ–Ω–ª–∞–π–Ω</div>
  <div style="margin-left:auto" class="controls">
    <button id="themeToggle" class="toggle" title="Theme">üåô</button>
    <button id="locateBtn" class="toggle" title="–ú–µ–Ω—ñ“£ –æ—Ä–Ω—ã–º">üìç –ú–µ–Ω</button>
    <button id="useMyAsOrigin" class="toggle" title="–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –æ—Ä–Ω—ã–Ω –±–∞“ì—ã—Ç —Ä–µ—Ç—ñ–Ω–¥–µ “õ–æ–ª–¥–∞–Ω—É">üîÅ “ö–æ–ª–¥–∞–Ω—É—à—ã –±–∞—Å—Ç–∞–ø“õ—ã</button>
    <button id="favsOpen" class="toggle" title="–°“Ø–π—ñ–∫—Ç—ñ –Ω—ã—Å–∞–Ω–¥–∞—Ä">‚òÖ –°“Ø–π—ñ–∫—Ç—ñ</button>
    <button id="panelToggle" class="toggle mobile-toggle" title="–ü–∞–Ω–µ–ª—å–¥—ñ –∫”©—Ä—Å–µ—Ç—É/–∂–∞—Å—ã—Ä—É">–ü–∞–Ω–µ–ª—å</button>
  </div>
</header>

<div id="topbar">
  <input id="search" type="text" placeholder="–Ü–∑–¥–µ—É ‚Äî –∞—Ç–∞—É –±–æ–π—ã–Ω—à–∞ (–º—ã—Å–∞–ª—ã: –ë–æ–∑–∂—ã—Ä–∞)" aria-label="–Ü–∑–¥–µ—É"/>
  <select id="categoryFilter" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
    <option value="all">–ë–∞—Ä–ª—ã“ì—ã</option>
    <option value="–º–µ—à—ñ—Ç">–ú–µ—à—ñ—Ç üïå</option>
    <option value="“õ–æ—Ä—ã–º">“ö–æ—Ä—ã–º ‚ö±Ô∏è</option>
    <option value="“õ–∞–ª–∞—à—ã“õ">“ö–∞–ª–∞—à—ã“õ üè∞</option>
    <option value="–ø–µ—Ç—Ä–æ–≥–ª–∏—Ñ">–ü–µ—Ç—Ä–æ–≥–ª–∏—Ñ ‚õ∞Ô∏è</option>
  </select>
  <div id="slider" style="width:260px" aria-hidden="true"></div>
</div>

<div id="main">
  <div id="leftCol">
    <div id="map" role="region" aria-label="–ö–∞—Ä—Ç–∞"></div>
    <div style="max-width:1200px;margin:10px auto;padding:0 12px;">
      <div class="chip">üí° –ù“±—Å“õ–∞—É: –Ω—ã—Å–∞–Ω–¥—ã –±–∞—Å—Å–∞“£—ã–∑ ‚Äî –æ“£ –∂–∞“õ –ø–∞–Ω–µ–ª—å–¥–µ —Ç–æ–ª—ã“õ –∞“õ–ø–∞—Ä–∞—Ç –∞—à—ã–ª–∞–¥—ã. "–ê–∫—Ç–∞—É–¥–∞–Ω –±–∞—Ä—É" –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã–ø –Ω–∞–≤–∏–≥–∞—Ü–∏—è–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑.</div>
    </div>
  </div>

  <div id="rightCol">
    <div id="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">–ù—ã—Å–∞–Ω–¥–∞—Ä</div>
        <div class="small">–¢–∞–±—ã–ª“ì–∞–Ω: <span id="count">0</span></div>
      </div>

      <div class="controls-row">
        <div class="pill">“í–∞—Å—ã—Ä: <span id="rangeLabel">1 - 21</span></div>
        <div style="margin-left:auto">
          <button id="clearFilters" class="toggle">–§–∏–ª—å—Ç—Ä–¥—ñ —Ç–∞–∑–∞–ª–∞—É</button>
        </div>
      </div>

      <div class="faq-row">
        <button class="faq-btn" data-q="oldest">üìç –ï“£ –∫”©–Ω–µ –Ω—ã—Å–∞–Ω</button>
        <button class="faq-btn" data-q="mosques">üïå –ú–µ—à—ñ—Ç—Ç–µ—Ä</button>
        <button class="faq-btn" data-q="burials">‚ö±Ô∏è “ö–æ—Ä—ã–º–¥–∞—Ä</button>
        <button class="faq-btn" data-q="share">üîó –ë”©–ª—ñ—Å—É –Ω“±—Å“õ–∞—É—ã</button>
      </div>

      <div id="cardList" class="card-list" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<!-- Chat widget -->
<button id="chat-toggle" aria-label="–ß–∞—Ç">–ß–∞—Ç</button>
<div id="chat-widget" role="dialog" aria-label="–°–∞–π—Ç —á–∞—Ç-–±–æ—Ç—ã">
  <div class="cw-header">
    <span>–ö”©–º–µ–∫—à—ñ –±–æ—Ç</span>
    <button id="chat-close" style="background:transparent;color:#fff;border:none;font-size:18px;cursor:pointer">√ó</button>
  </div>
  <div class="cw-body" id="cw-body" aria-live="polite"></div>
  <div class="cw-input">
    <input id="cw-input" type="text" placeholder="–°“±—Ä–∞“ì—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑..." />
    <button id="cw-send" class="btn">–ñ—ñ–±–µ—Ä—É</button>
  </div>
</div>

<footer>¬© Mangystau Map AI ‚Äî –ñ–æ–±–∞ —Ç”ô–∂—ñ—Ä–±–∏–µ–ª—ñ–∫ –º–∞“õ—Å–∞—Ç—Ç–∞. Open data & images may be ¬© their owners.</footer>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

<script>
/* ------------------------------
   Config & state
   ------------------------------ */
const DEFAULT_PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
  `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'>
     <rect width='100%' height='100%' fill='#e6eef8'/>
     <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#1976d2' font-family='Arial' font-size='24'>–°—É—Ä–µ—Ç –∂–æ“õ</text>
   </svg>`
);
const OPENWEATHER_API_KEY = '';
const CHAT_API = '/api/chat';

let places = []; // loaded from places.json
const markers = [];
const markerClusterGroup = L.markerClusterGroup();
const cardList = document.getElementById('cardList');
const countEl = document.getElementById('count');
const searchInput = document.getElementById('search');
const categorySelect = document.getElementById('categoryFilter');
const rangeLabel = document.getElementById('rangeLabel');
const clearBtn = document.getElementById('clearFilters');

let currentRange = [1,21];
let routeControl = null;
let userLocation = null; // {lat, lng} if user gave permission
let useUserAsOrigin = false;

/* ------------------------------
   Map init
   ------------------------------ */
const aktau = [43.65, 51.15];
const map = L.map('map', {preferCanvas:true}).setView(aktau, 9);
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'Tiles ¬© Esri' }).addTo(map);
const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' });
const baseLayers = { "Satellite": satellite, "OSM": osm };
L.control.layers(baseLayers, {}, {position:'topright'}).addTo(map);
map.addLayer(markerClusterGroup);

/* ------------------------------
   Helpers
   ------------------------------ */
function debounce(fn, t=200){ let to; return function(...a){ clearTimeout(to); to=setTimeout(()=>fn.apply(this,a), t); }; }
function norm(s){ return String(s || '').trim().toLowerCase(); }
function formatCoords(c){ return `${c[0].toFixed(5)}, ${c[1].toFixed(5)}`; }

/* open navigation - add 2GIS option and prefer user origin when requested */
function openNav(lat,lng){
  const g = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
  const y = `https://yandex.com/maps/?rtext=&rtt=auto&rtm=0&ll=${lng},${lat}&z=12`;
  const two = `https://2gis.kz/?query=${encodeURIComponent(lat + ',' + lng)}`;

  if(useUserAsOrigin && userLocation){
    const origin = `${userLocation.lat},${userLocation.lng}`;
    const gRoute = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${lat},${lng}`;
    const yRoute = `https://yandex.com/maps/?rtext=${origin}~${lat},${lng}&rtt=auto`;
    const twoRoute = `https://2gis.kz/routeSearch/rsType/car/from/${encodeURIComponent(userLocation.lng + ',' + userLocation.lat)}/to/${encodeURIComponent(lng + ',' + lat)}`;
    const win = window.open('', '_blank');
    win.document.body.innerHTML = `<p>–ù–∞–≤–∏–≥–∞—Ü–∏—è–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑ (–±–∞—Å—Ç–∞–ø“õ—ã: —Å—ñ–∑–¥—ñ“£ –æ—Ä–Ω—ã“£—ã–∑):</p>
      <a href="${gRoute}" target="_blank">Google Maps</a><br/>
      <a href="${yRoute}" target="_blank">Yandex Maps</a><br/>
      <a href="${twoRoute}" target="_blank">2GIS</a>`;
    return;
  }

  const win = window.open('', '_blank');
  win.document.body.innerHTML = `<p>–ù–∞–≤–∏–≥–∞—Ü–∏—è–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑:</p>
    <a href="${g}" target="_blank">Google Maps</a><br/>
    <a href="${y}" target="_blank">Yandex Maps</a><br/>
    <a href="${two}" target="_blank">2GIS</a>`;
}

/* add route control - origin uses userLocation if opted-in */
function addRoute(toCoords){
  if(routeControl) map.removeControl(routeControl);
  const origin = (useUserAsOrigin && userLocation) ? L.latLng(userLocation.lat,userLocation.lng) : L.latLng(aktau[0],aktau[1]);
  routeControl = L.Routing.control({
    waypoints: [origin, L.latLng(toCoords[0], toCoords[1])],
    lineOptions: { styles: [{color: '#1976d2', weight: 6}] },
    show: false,
    addWaypoints: false,
    draggableWaypoints: false
  }).addTo(map);
}

/* ------------------------------
   Load places.json then render
   ------------------------------ */
async function loadPlaces(){
  try{
    const res = await fetch('/places.json');
    if(!res.ok) throw new Error('places.json not found');
    places = await res.json();
  }catch(e){
    console.warn('Failed to load places.json, using inline fallback', e);
    places = [];
  }
  renderAll();
  applyFilters();
}
loadPlaces();

/* ------------------------------
   Render markers & cards
   ------------------------------ */
function clearMarkersAndCards(){
  markerClusterGroup.clearLayers();
  markers.length = 0;
  cardList.innerHTML = '';
}

function renderAll(){
  clearMarkersAndCards();
  const favs = JSON.parse(localStorage.getItem('mangystau_favs') || '[]');

  places.forEach((p, idx) => {
    const imgSrc = p.img && p.img.length ? p.img : DEFAULT_PLACEHOLDER;
    const icon = L.divIcon({ className:'emoji-marker', html: `<div style="font-size:22px">${p.emoji||'üìç'}</div>`, iconSize:[30,30]});
    const marker = L.marker(p.coords, {icon});
    marker.bindPopup(`<b>${p.name}</b><br><img style="width:160px;display:block;border-radius:8px;margin-top:6px" src="${imgSrc}" alt="${p.name}" loading="lazy"><p style="margin-top:6px">${p.desc}</p>
      <div style="margin-top:6px;display:flex;gap:6px">
        <button onclick="flyToPlace(${p.coords[0]},${p.coords[1]})" class="btn">–ê—à—É</button>
        <button onclick="openNav(${p.coords[0]},${p.coords[1]})" class="toggle">–ù–∞–≤–∏–≥–∞—Ü–∏—è</button>
        <button onclick="addRoute([${p.coords[0]},${p.coords[1]}])" class="toggle">üöó –ñ–æ–ª</button>
      </div>`);
    marker.placeIndex = idx;
    marker.category = p.cat;
    marker.century = p.century || 0;
    markers.push({marker, place:p});
    markerClusterGroup.addLayer(marker);

    // card
    const card = document.createElement('div');
    card.className = 'card';
    const favOn = favs.includes(idx);
    card.innerHTML = `
      <img src="${imgSrc}" alt="${p.name}" loading="lazy" onerror="this.src='${DEFAULT_PLACEHOLDER}'" />
      <div class="meta">
        <h3>${p.name} ${p.emoji||''}</h3>
        <p>${p.desc}</p>
        <div class="small">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${p.cat} ‚Ä¢ “í–∞—Å—ã—Ä: ${p.century || '‚Äî'}</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button class="toggle show-btn">–ö–∞—Ä—Ç–∞–¥–∞ –∫”©—Ä—Å–µ—Ç—É</button>
          <button class="toggle nav-btn">–ù–∞–≤–∏–≥–∞—Ü–∏—è</button>
          <button class="fav" title="–ñ–∞“£–∞–ª—ã“õ“õ–∞ “õ–æ—Å—É/–∞–ª—ã–ø —Ç–∞—Å—Ç–∞—É">${favOn ? '‚òÖ' : '‚òÜ'}</button>
        </div>
      </div>`;
    cardList.appendChild(card);

    // wiring: buttons
    card.querySelector('.show-btn').addEventListener('click', ()=>flyToPlace(p.coords[0], p.coords[1]));
    card.querySelector('.nav-btn').addEventListener('click', ()=>openNav(p.coords[0], p.coords[1]));
    const favBtn = card.querySelector('.fav');
    favBtn.addEventListener('click', ()=>{ toggleFav(idx); favBtn.textContent = JSON.parse(localStorage.getItem('mangystau_favs')||'[]').includes(idx) ? '‚òÖ' : '‚òÜ'; });

    // marker <-> card sync
    marker.on('click', ()=> {
      flyToPlace(p.coords[0], p.coords[1]);
      card.scrollIntoView({behavior:'smooth', block:'center'});
    });
  });

  updateCount();
}

/* flyTo + popup */
function flyToPlace(lat, lng){
  map.flyTo([lat,lng], 13, {duration:1.2});
  const found = markers.find(m=>m.place.coords[0]===lat && m.place.coords[1]===lng);
  if(found) found.marker.openPopup();
}

/* ------------------------------
   Improved filter logic (normalized)
   ------------------------------ */
function updateCount(){
  try {
    const visible = markers.filter(m => markerClusterGroup.hasLayer(m.marker));
    countEl.textContent = visible.length;
  } catch (e) {
    console.error('updateCount error', e);
    countEl.textContent = '0';
  }
}

function applyFilters(){
  const cat = norm(categorySelect.value || 'all');
  const q = String(searchInput.value || '').trim().toLowerCase();

  if(!Array.isArray(currentRange) || currentRange.length !== 2) currentRange = [1,21];

  markers.forEach(m=>{
    const p = m.place || {};
    const pCat = norm(p.cat);
    const pCentury = Number.isFinite(Number(p.century)) ? Number(p.century) : 0;
    const name = String(p.name || '').toLowerCase();
    const desc = String(p.desc || '').toLowerCase();

    const inCat = (cat === 'all') || (pCat === cat);
    const inRange = (pCentury >= currentRange[0] && pCentury <= currentRange[1]);
    const inSearch = !q || name.includes(q) || desc.includes(q);

    if(inCat && inRange && inSearch){
      if(!markerClusterGroup.hasLayer(m.marker)) markerClusterGroup.addLayer(m.marker);
    } else {
      if(markerClusterGroup.hasLayer(m.marker)) markerClusterGroup.removeLayer(m.marker);
    }
  });

  // Sync card list
  const cards = cardList.children;
  for(let i=0;i<cards.length;i++){
    const p = places[i] || {};
    const pCat = norm(p.cat);
    const pCentury = Number.isFinite(Number(p.century)) ? Number(p.century) : 0;
    const name = String(p.name || '').toLowerCase();
    const desc = String(p.desc || '').toLowerCase();

    const show = ((cat === 'all') || pCat === cat) &&
                 (pCentury >= currentRange[0] && pCentury <= currentRange[1]) &&
                 (!q || name.includes(q) || desc.includes(q));
    cards[i].style.display = show ? 'flex' : 'none';
  }

  updateCount();
}

/* slider */
const slider = document.getElementById('slider');
noUiSlider.create(slider, {
  start: [1,21],
  connect:true,
  step:1,
  range:{ min:1, max:21 },
  tooltips:[true,true],
  format:{to:(v)=>Math.round(v), from:(v)=>Number(v)}
});
slider.noUiSlider.on('update', vals => {
  currentRange = vals.map(v=>parseInt(v));
  rangeLabel.textContent = currentRange[0] + ' - ' + currentRange[1];
  applyFilters();
});

/* search + category events */
searchInput.addEventListener('input', debounce(()=>applyFilters(), 250));
categorySelect.addEventListener('change', applyFilters);
clearBtn.addEventListener('click', ()=>{ searchInput.value=''; categorySelect.value='all'; slider.noUiSlider.set([1,21]); applyFilters(); });

/* favourites (localStorage) */
function toggleFav(idx){
  const key = 'mangystau_favs';
  const favs = JSON.parse(localStorage.getItem(key) || '[]');
  const i = favs.indexOf(idx);
  if(i>=0){ favs.splice(i,1); } else { favs.push(idx); }
  localStorage.setItem(key, JSON.stringify(favs));
  // update icons
  document.querySelectorAll('.card').forEach((card, id)=> {
    const favBtn = card.querySelector('.fav');
    if(!favBtn) return;
    favBtn.textContent = favs.includes(id) ? '‚òÖ' : '‚òÜ';
  });
}

/* favs list open */
document.getElementById('favsOpen').addEventListener('click', ()=>{
  const favs = JSON.parse(localStorage.getItem('mangystau_favs') || '[]');
  if(!favs.length) return alert('–°“Ø–π—ñ–∫—Ç—ñ –Ω—ã—Å–∞–Ω–¥–∞—Ä –∂–æ“õ');
  const names = favs.map(i=>places[i]?.name || '‚Äî').join('\n');
  alert('–°“Ø–π—ñ–∫—Ç—ñ –Ω—ã—Å–∞–Ω–¥–∞—Ä:\n' + names);
});

/* locate user (sets userLocation) */
document.getElementById('locateBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation “õ–æ–ª–¥–∞–º–∞–π–¥—ã'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    const m = L.circle([userLocation.lat,userLocation.lng], {radius:50, color:'#1976d2', fill:true, fillOpacity:0.15}).addTo(map);
    map.flyTo([userLocation.lat,userLocation.lng], 13);
    setTimeout(()=>{ map.removeLayer(m); }, 8000);
    alert('–û—Ä–Ω—ã“£ –∞–Ω—ã“õ—Ç–∞–ª–¥—ã –∂”ô–Ω–µ “õ–æ–ª–¥–∞–Ω—É“ì–∞ –¥–∞–π—ã–Ω: ' + userLocation.lat.toFixed(5) + ', ' + userLocation.lng.toFixed(5));
  }, err => { alert('–û—Ä–Ω—ã“£ –∞–Ω—ã“õ—Ç–∞–ª–º–∞–¥—ã: ' + err.message); }, {enableHighAccuracy:true});
});

/* toggle using user's location as origin */
document.getElementById('useMyAsOrigin').addEventListener('click', ()=>{
  useUserAsOrigin = !useUserAsOrigin;
  document.getElementById('useMyAsOrigin').textContent = useUserAsOrigin ? 'üîÅ –ë–∞—Å—Ç–∞–ø“õ—ã: –°—ñ–∑' : 'üîÅ “ö–æ–ª–¥–∞–Ω—É—à—ã –±–∞—Å—Ç–∞–ø“õ—ã';
  if(useUserAsOrigin && !userLocation){
    document.getElementById('locateBtn').click();
  }
});

/* panel toggle for mobile */
document.getElementById('panelToggle').addEventListener('click', ()=>{
  const p = document.getElementById('panel');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
});

/* theme toggle */
const themeBtn = document.getElementById('themeToggle');
themeBtn.addEventListener('click', ()=>{
  const root = document.body;
  const cur = root.getAttribute('data-theme') || 'light';
  const next = cur==='light' ? 'dark' : 'light';
  root.setAttribute('data-theme', next);
  themeBtn.textContent = next==='dark' ? '‚òÄÔ∏è' : 'üåô';
});

/* weather on hover (optional) */
async function fetchWeather(lat, lon){
  if(!OPENWEATHER_API_KEY) return null;
  try{
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OPENWEATHER_API_KEY}`;
    const res = await fetch(url);
    if(!res.ok) return null;
    const data = await res.json();
    return `${data.weather[0].main} ${Math.round(data.main.temp)}¬∞C`;
  }catch(e){ return null; }
}

/* attach hover tooltip */
function attachHoverWeather(){
  markers.forEach(m=>{
    m.marker.on('mouseover', async ()=>{
      const w = await fetchWeather(m.place.coords[0], m.place.coords[1]);
      if(w) m.marker.bindTooltip(w, {direction:'top'}).openTooltip();
    });
    m.marker.on('mouseout', ()=>{ m.marker.closeTooltip(); });
  });
}
setTimeout(()=>attachHoverWeather(), 800);

/* ------------------------------
   Chat widget logic (front-end)
   ------------------------------ */
const chatToggle = document.getElementById('chat-toggle');
const chatWidget = document.getElementById('chat-widget');
const chatClose = document.getElementById('chat-close');
const cwBody = document.getElementById('cw-body');
const cwInput = document.getElementById('cw-input');
const cwSend = document.getElementById('cw-send');

chatToggle.addEventListener('click', ()=>{ chatWidget.style.display='flex'; appendBot('–°”ô–ª–µ–º! –°“±—Ä–∞“õ “õ–æ–π—ã“£—ã–∑ –Ω–µ–º–µ—Å–µ —Ç”©–º–µ–Ω–¥–µ–≥—ñ –±–∞—Ç—ã—Ä–º–∞–ª–∞—Ä–¥—ã –±–∞—Å—ã“£—ã–∑.'); });
chatClose.addEventListener('click', ()=>{ chatWidget.style.display='none'; });

function appendBot(text){ const d=document.createElement('div'); d.className='msg-bot'; d.textContent=text; cwBody.appendChild(d); cwBody.scrollTop=cwBody.scrollHeight; }
function appendUser(text){ const d=document.createElement('div'); d.className='msg-user'; d.textContent=text; cwBody.appendChild(d); cwBody.scrollTop=cwBody.scrollHeight; }

cwSend.addEventListener('click', sendChat);
cwInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(); });

let typingIndicator = null;
function showTyping(){ typingIndicator = document.createElement('div'); typingIndicator.className='msg-bot'; typingIndicator.textContent = '–ñ–∞—É–∞–ø –∂–∞–∑—ã–ª—É–¥–∞...'; cwBody.appendChild(typingIndicator); cwBody.scrollTop=cwBody.scrollHeight; }
function hideTyping(){ if(typingIndicator){ typingIndicator.remove(); typingIndicator=null; } }

async function sendChat(){
  const text = cwInput.value.trim();
  if(!text) return;
  appendUser(text);
  cwInput.value='';
  showTyping();
  try{
    const res = await fetch(CHAT_API, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:text})});
    hideTyping();
    if(!res.ok){
      const txt = await res.text().catch(()=>null);
      appendBot('“ö–∞—Ç–µ: —Å–µ—Ä–≤–µ—Ä –∂–∞—É–∞–ø –±–µ—Ä–º–µ–¥—ñ. ' + (txt || res.status));
      return;
    }
    const data = await res.json();
    appendBot(data.answer || data.answerText || '–ñ–∞—É–∞–ø –∞–ª—ã–Ω–±–∞–¥—ã');
  }catch(e){
    hideTyping();
    appendBot('“ö–∞—Ç–µ: —Å–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª–º–∞–¥—ã –Ω–µ–º–µ—Å–µ CHAT_API —Ç–µ“£—à–µ–ª–º–µ–≥–µ–Ω. (–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–µ—Ä–µ–∫)');
  }
}

/* ------------------------------
   Improved FAQ quick buttons (use normalized category counting)
   ------------------------------ */
document.querySelectorAll('.faq-btn').forEach(btn=>{
  // remove old onclicks by cloning node (defensive)
  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);
  newBtn.addEventListener('click', ()=>{
    const q = newBtn.dataset.q;
    if(q==='oldest'){
      const sorted = (places || []).slice().sort((a,b)=> (Number(a.century)||999)-(Number(b.century)||999));
      appendBot('–ï“£ –∫”©–Ω–µ –Ω—ã—Å–∞–Ω ‚Äî ' + (sorted[0]?.name || '‚Äî') + ' ‚Ä¢ “í–∞—Å—ã—Ä: ' + (sorted[0]?.century||'‚Äî'));
    } else if(q==='mosques'){
      const n = (places || []).filter(p=> norm(p.cat) === '–º–µ—à—ñ—Ç').length;
      appendBot('–ú–µ—à—ñ—Ç—Ç–µ—Ä —Å–∞–Ω—ã: ' + n);
    } else if(q==='burials'){
      const n = (places || []).filter(p=> norm(p.cat) === '“õ–æ—Ä—ã–º').length;
      appendBot('“ö–æ—Ä—ã–º–¥–∞—Ä —Å–∞–Ω—ã: ' + n);
    } else if(q==='share'){
      appendBot('–ù—ã—Å–∞–Ω–¥—ã –±”©–ª—ñ—Å—É “Ø—à—ñ–Ω: –∫–∞—Ä—Ç–∞–¥–∞–Ω –Ω—ã—Å–∞–Ω–¥—ã –∞—à—ã–ø, –±—Ä–∞—É–∑–µ—Ä URL-—ñ–Ω –∫”©—à—ñ—Ä—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ "–ù–∞–≤–∏–≥–∞—Ü–∏—è" —ñ—à—ñ–Ω–¥–µ —Å—ñ–ª—Ç–µ–º–µ –±”©–ª—ñ—Å—ñ“£—ñ–∑.');
    }
  });
});

/* ------------------------------
   Expose some functions globally for inline onclicks in popups
   ------------------------------ */
window.flyToPlace = flyToPlace;
window.openNav = openNav;
window.addRoute = addRoute;

/* Fin */
</script>
</body>
</html>
